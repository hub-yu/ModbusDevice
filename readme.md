# STM32F103 设备寄存器映射说明

## 内存布局
stm32f103 基地址: 0x800fc00 (FLASH_ADDR)

| 偏移量 | 大小 | 名称 | 说明 |
|--------|------|------|------|
| 0x00   | 4    | reg_out | 输出寄存器状态 |
| 0x04   | 4    | reg_in  | 输入寄存器状态 |
| 0x08   | 64   | reg_val | 模拟量寄存器(32个) |
| 0x48   | 70   | regs    | 保持寄存器(35个) |

## 保持寄存器(REGS)说明

| 地址 | 名称 | 说明 | 默认值 |
|------|------|------|--------|
| 0    | REG_DEVICEID | 设备ID | 0 |
| 1    | REG_REBOOT | 重启控制 | 0 |
| 2-7  | REG_UART_[0-5] | 串口相关保留寄存器 | 0 |
| 8-11  | REG_NET_IP_[0-3] | 设备IP地址 | 192.168.1.49 |
| 12-15 | REG_NET_GATEWAY_[0-3] | 网关地址 | 192.168.1.1 |
| 16-19 | REG_NET_MASK_[0-3] | 子网掩码 | 255.255.255.0 |
| 20-25 | REG_NET_MAC_[0-5] | MAC地址 | 由设备UID生成 |
| 26-33 | REG_NET_PORT_[0-7] | 网络端口配置 | 50000-50007 |

注意：
1. 设备ID默认为0，可修改为0-247范围内的任意值，0为广播地址
2. 写入REG_REBOOT寄存器任意非0值将触发设备重启
3. MAC地址默认由设备唯一ID(UID)生成,确保同一网络下不会冲突
4. 网络端口默认从50000开始递增,对应8个socket，目前使用两个分别时udp:50000 tcp-server:50001
5. 上电时检测拨码S3,判断是否开启串口日志输出
6. 上电时检测拨码S1,判断是否恢复出厂设置，即保持寄存器恢复默认值
7. 对于保持寄存器及数字输出，采用延时写入FLASH以增加寿命，即未收到任何数据包后的两秒后，保存数据到最后flash一页中

## 数字输入输出说明

- reg_out: 32位输出寄存器，每位控制一个输出通道，共支持8个输出
- reg_in: 32位输入寄存器，每位表示一个输入通道状态，共支持8个输入

## 模拟量寄存器说明

- reg_val: 32个16位寄存器，用于存储模拟量数据

